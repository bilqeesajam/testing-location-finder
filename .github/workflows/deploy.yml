name: CD - Deploy Frontend, Simulate Backend
on:
  push:
    branches: [main]

jobs:
  simulate-backend:
    runs-on: ubuntu-latest
    outputs:
      backend_type: ${{ steps.check-backend.outputs.backend_type }}
      backend_url: ${{ steps.simulate.outputs.backend_url }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate project
        run: node scripts/validate.cjs
        
      - name: Check backend type
        id: check-backend
        run: |
          if [ -f "backend/package.json" ]; then
            echo "backend_type=node" >> $GITHUB_OUTPUT
          elif [ -d "supabase/functions/" ]; then
            echo "backend_type=supabase" >> $GITHUB_OUTPUT
          else
            echo "backend_type=none" >> $GITHUB_OUTPUT
          fi
        
      - name: Simulate backend deployment
        id: simulate
        run: |
          # EASILY CHANGEABLE SIMULATION - MODIFY THIS BLOCK FOR REAL DEPLOYMENT
          echo "üöÄ SIMULATING backend deployment..."
          
          if [ "${{ steps.check-backend.outputs.backend_type }}" = "node" ]; then
            echo "üì¶ Would deploy Node.js backend to Render"
            echo "backend_url=https://test-backend.onrender.com" >> $GITHUB_OUTPUT
          elif [ "${{ steps.check-backend.outputs.backend_type }}" = "supabase" ]; then
            echo "üóÑÔ∏è Would deploy Supabase Edge Functions"
            echo "backend_url=https://test-project.supabase.co/functions/v1" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No backend detected"
            echo "backend_url=https://mock-api.example.com" >> $GITHUB_OUTPUT
          fi
          
          echo "‚úÖ Backend simulation complete"
          echo "üí° TO DEPLOY FOR REAL: Replace this step with actual deployment commands"
          
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: simulate-backend
    env:
      VITE_API_URL: ${{ needs.simulate-backend.outputs.backend_url }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://test-supabase.supabase.co' }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'test-key' }}
      VITE_MAPTILER_KEY: ${{ secrets.VITE_MAPTILER_KEY || 'test-key' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install and build frontend
        run: |
          npm ci
          npm run build
          
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prod --confirm'
          
      - name: Show deployment info
        run: |
          echo "‚úÖ DEPLOYMENT COMPLETE"
          echo "üåê Frontend: Live on Vercel"
          echo "üîß Backend type: ${{ needs.simulate-backend.outputs.backend_type }}"
          echo "üì° Backend URL: ${{ needs.simulate-backend.outputs.backend_url }}"
          echo ""
          echo "üí° FOR REAL BACKEND DEPLOYMENT:"
          echo "   1. Update the 'Simulate backend deployment' step in deploy.yml"
          echo "   2. Add your Render/Supabase deployment commands"
          echo "   3. Add necessary secrets to GitHub"